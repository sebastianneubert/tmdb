name: Build and Release

on:
  push:
    tags:
      - '[0-9]+.[0-9]+.[0-9]+*'

permissions:
  contents: write

jobs:
  build-and-release:
    name: Build and Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Get version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Build binaries
        run: |
          # Create dist directory
          mkdir -p dist
          
          # Windows AMD64
          GOOS=windows GOARCH=amd64 go build -ldflags="-s -w -X main.version=${{ steps.get_version.outputs.VERSION }}" -o dist/tmdb-win64.exe cmd/main.go
          
          # macOS AMD64 (Intel)
          GOOS=darwin GOARCH=amd64 go build -ldflags="-s -w -X main.version=${{ steps.get_version.outputs.VERSION }}" -o dist/tmdb-darwin-amd64 cmd/main.go
          
          # macOS ARM64 (Apple Silicon)
          GOOS=darwin GOARCH=arm64 go build -ldflags="-s -w -X main.version=${{ steps.get_version.outputs.VERSION }}" -o dist/tmdb-darwin-arm64 cmd/main.go
          
          # Linux AMD64
          GOOS=linux GOARCH=amd64 go build -ldflags="-s -w -X main.version=${{ steps.get_version.outputs.VERSION }}" -o dist/tmdb-linux-amd64 cmd/main.go
          
          # Linux ARM64
          GOOS=linux GOARCH=arm64 go build -ldflags="-s -w -X main.version=${{ steps.get_version.outputs.VERSION }}" -o dist/tmdb-linux-arm64 cmd/main.go

      - name: Create checksums
        run: |
          cd dist
          sha256sum * > checksums.txt
          cat checksums.txt

      - name: Get Existing Release Body (if any)
        id: get_body
        uses: actions/github-script@v6
        with:
          script: |
            const { owner, repo } = context.repo;
            const tag = process.env.GITHUB_REF.replace('refs/tags/', '');

            try {
              const release = await github.rest.repos.getReleaseByTag({
                owner,
                repo,
                tag,
              });

              // Output the existing body to be used in the next step
              core.setOutput('existing_body', release.data.body);

            } catch (error) {
              // If the release doesn't exist yet, this will fail.
              // We can safely ignore the error and set an empty body.
              core.setOutput('existing_body', '');
            }

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            dist/tmdb-win64.exe
            dist/tmdb-darwin-amd64
            dist/tmdb-darwin-arm64
            dist/tmdb-linux-amd64
            dist/tmdb-linux-arm64
            dist/checksums.txt
          body: |
            ${{ steps.get_body.outputs.existing_body }}

            ---

            ### Installation of tmdb ${{ steps.get_version.outputs.VERSION }}
            
            Download the appropriate binary for your system:
            
            - **Windows (64-bit)**: `tmdb-win64.exe`
            - **macOS (Intel)**: `tmdb-darwin-amd64`
            - **macOS (Apple Silicon)**: `tmdb-darwin-arm64`
            - **Linux (64-bit)**: `tmdb-linux-amd64`
            - **Linux (ARM64)**: `tmdb-linux-arm64`
            
            ### Usage
            
            ```bash
            # macOS/Linux: Make executable
            chmod +x tmdb-*
            
            # Run
            ./tmdb-darwin-arm64 --help
            ```
            
            ### Verify checksums
            
            ```bash
            sha256sum -c checksums.txt
            ```

          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}